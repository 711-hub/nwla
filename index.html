<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Auto Check Blokir (Skiddle — GitHub Pages Ready)</title>
<style>
  :root{
    --bg:#0b0f14; --card:#111826; --muted:#7d8aa5; --text:#e7eefc; --ok:#28c76f; --bad:#ff4d4f; --warn:#faae2b; --line:#22324a; --accent:#4f46e5;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu}
  header{position:sticky;top:0;background:rgba(11,15,20,.8);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);z-index:10}
  h1{font-size:18px;margin:0;padding:14px 18px}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:14px;padding:14px}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px}
  .card h2{font-size:15px;margin:0 0 10px}
  .left{padding:14px}
  label{display:block;color:var(--muted);margin:8px 0 6px}
  textarea{width:100%;min-height:180px;border-radius:10px;border:1px solid var(--line);background:#0c1422;color:var(--text);padding:10px;resize:vertical}
  input[type="number"]{width:100%;border-radius:10px;border:1px solid var(--line);background:#0c1422;color:var(--text);padding:10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--line);background:#121b2b;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#395176}
  .btn.on{background:var(--accent);border-color:var(--accent)}
  .btn.stop{background:#1f2937}
  .muted{color:var(--muted)}
  .stat{display:flex;gap:12px;flex-wrap:wrap}
  .chip{background:#0e1626;border:1px solid var(--line);border-radius:999px;padding:6px 10px}
  .chip b{margin-right:4px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:9px 10px;border-bottom:1px solid var(--line);vertical-align:top}
  th{color:#b6c2df;text-align:left;background:#0f1726;position:sticky;top:0;z-index:5}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .bar{display:flex;gap:8px;margin:10px 0 0}
  .small{font-size:12px}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0e1626;color:#b6c2df}
  .tblwrap{overflow:auto;border-radius:0 0 14px 14px}
</style>
</head>
<body>
<header><h1>Auto Check Blokir (Kominfo / TRUST+ via Skiddle)</h1></header>

<div class="wrap">
  <!-- Panel kiri -->
  <section class="card left">
    <h2>Daftar Link/Domain</h2>
    <label for="urls">Masukkan URL/Domain (pisah baris, max 200)</label>
    <textarea id="urls" placeholder="ayutogel.com
hantogel.com
https://sub.domain.id/path"></textarea>

    <label for="interval" class="row" style="justify-content:space-between">
      <span>Interval cek (detik)</span>
      <span class="muted small">default 30 dtk</span>
    </label>
    <input id="interval" type="number" min="5" max="600" step="5" value="30"/>

    <div class="bar">
      <button id="saveList" class="btn">Simpan Daftar</button>
      <button id="start" class="btn on">ON</button>
      <button id="stop" class="btn stop">OFF</button>
      <button id="reset" class="btn" title="Hapus semua data & mulai ulang">Reset</button>
    </div>

    <div class="hint">
      • Data tersimpan lokal • Paralel terbatas • Siap GitHub Pages (fallback proxy CORS).<br>
      • Endpoint: <span class="pill mono" id="apiLabel"></span>
    </div>

    <div style="margin-top:12px" class="stat">
      <span class="chip"><b>Total:</b><span id="statTotal">0</span></span>
      <span class="chip"><b>OK:</b><span id="statOk">0</span></span>
      <span class="chip"><b>Terblokir:</b><span id="statBad">0</span></span>
      <span class="chip"><b>Terakhir Cek:</b><span id="statLast">-</span></span>
    </div>
  </section>

  <!-- Panel kanan -->
  <section class="card" style="display:flex;flex-direction:column;min-height:420px">
    <div style="padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <h2 style="margin:0">Hasil Pemantauan</h2>
      <span class="pill" id="statusRun">Status: berhenti</span>
    </div>

    <div class="tblwrap">
      <table id="tblAll">
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th>Domain</th>
            <th>Status</th>
            <th>Sumber</th>
            <th>Detail</th>
            <th>Terakhir Cek</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="padding:12px 14px;border-top:1px solid var(--line);display:flex;align-items:center;gap:8px">
      <h2 style="margin:0">Terblokir</h2>
      <span class="pill bad">Tabel domain yang terdeteksi diblokir</span>
    </div>
    <div class="tblwrap">
      <table id="tblBlocked">
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th>Domain</th>
            <th>Sumber</th>
            <th>Alasan/Detail</th>
            <th>Sejak</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/** =================== KONFIGURASI =================== **/
// URL Skiddle yang benar: ?domain=<DOMAIN>&json=true
function buildDirectUrl(domain){
  return 'https://check.skiddle.id/?domain=' + encodeURIComponent(domain) + '&json=true';
}
const MAX_CONCURRENT = 8;        // request paralel
const REQ_TIMEOUT    = 12000;    // ms
const USE_PROXY      = true;     // aktifkan fallback proxy untuk GitHub Pages

/** ============== UTIL ============== **/
const $ = sel => document.querySelector(sel);
function nowStr(){ return new Date().toLocaleString(); }
function clampInt(v,min,max){ return Math.max(min, Math.min(max, Math.floor(v))); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function normalizeDomain(input){
  if (!input) return null;
  let s = String(input).trim();
  if (!s) return null;
  try {
    if (/^https?:\/\//i.test(s) || /^\/\//.test(s)) { const u = new URL(s.startsWith('//') ? 'http:'+s : s); s = u.hostname; }
  } catch {}
  s = s.replace(/:\d+$/,'').replace(/\.$/,'').toLowerCase();
  if (!/^[a-z0-9.-]+$/.test(s)) return null;
  if (!s.includes('.') && !['localhost'].includes(s)) return null;
  return s.replace(/^\*\./,'');
}
function limitedParallel(execs, limit){
  return new Promise((resolve) => {
    let i = 0, active = 0, done = 0;
    const results = new Array(execs.length);
    const tick = () => {
      while (active < limit && i < execs.length) {
        const idx = i++, fn = execs[idx]; active++;
        fn().then(r=>results[idx]=r).catch(e=>results[idx]={error:String(e)})
          .finally(()=>{ active--; done++; (done===execs.length)?resolve(results):tick(); });
      }
    };
    tick();
  });
}

/** ============== STATE ============== **/
const elUrls = $('#urls'), elInterval = $('#interval'), elSaveList = $('#saveList');
const elStart = $('#start'), elStop = $('#stop'), elReset = $('#reset');
const elApiLabel = $('#apiLabel'), elStatusRun = $('#statusRun');
const elStatTotal = $('#statTotal'), elStatOk = $('#statOk'), elStatBad = $('#statBad'), elStatLast = $('#statLast');
const tblAll = document.querySelector('#tblAll tbody');
const tblBlocked = document.querySelector('#tblBlocked tbody');

let CHECK_TIMER = null;
let LIST = [];
let MAP = new Map();         // domain -> {blocked, lastCheck, source, reason}
let BLOCKED_MAP = new Map(); // domain -> {since, source, reason}

// Info endpoint di UI
if (elApiLabel) elApiLabel.textContent = 'https://check.skiddle.id/?domain={domain}&json=true';

/** ============== STORAGE ============== **/
const store = {
  load(){ try{ return JSON.parse(localStorage.getItem('acb-data')) || {list:[],interval:30}; }catch{ return {list:[],interval:30}; } },
  save(v){ localStorage.setItem('acb-data', JSON.stringify(v)); }
};

/** ============== RENDER ============== **/
function renderAllTable(){
  tblAll.innerHTML = '';
  let i=1, rows=[];
  for (const d of LIST){
    const m = MAP.get(d) || {};
    const status = m.blocked===true ? `<span class="bad">Terblokir</span>` :
                   m.blocked===false ? `<span class="ok">OK</span>` :
                                       `<span class="warn">Belum dicek</span>`;
    rows.push(`<tr>
      <td class="mono">${i++}</td>
      <td class="mono">${escapeHtml(d)}</td>
      <td>${status}</td>
      <td class="small mono">${m.source?escapeHtml(m.source):'-'}</td>
      <td class="small">${m.reason?escapeHtml(m.reason):'-'}</td>
      <td class="small">${m.lastCheck||'-'}</td>
    </tr>`);
  }
  tblAll.innerHTML = rows.join('');
}
function renderBlockedTable(){
  tblBlocked.innerHTML = '';
  let i=1, rows=[];
  for (const [d,info] of BLOCKED_MAP){
    rows.push(`<tr>
      <td class="mono">${i++}</td>
      <td class="mono">${escapeHtml(d)}</td>
      <td class="small">${info.source?escapeHtml(info.source):'-'}</td>
      <td class="small">${info.reason?escapeHtml(info.reason):'-'}</td>
      <td class="small">${info.since||'-'}</td>
    </tr>`);
  }
  tblBlocked.innerHTML = rows.join('');
}
function renderStats(){
  if (elStatTotal) elStatTotal.textContent = LIST.length;
  let ok=0,bad=0;
  for (const d of LIST){
    const m = MAP.get(d); if (!m) continue;
    if (m.blocked===true) bad++; else if (m.blocked===false) ok++;
  }
  if (elStatOk) elStatOk.textContent = ok;
  if (elStatBad) elStatBad.textContent = bad;
}

/** ============== FETCHER DENGAN FALLBACK PROXY ============== **/
// Rantai proxy: direct → corsproxy.io → allorigins/raw → allorigins/get (contents)
async function fetchJsonWithFallback(directUrl){
  // 1) direct
  try {
    const r = await fetchWithTimeout(directUrl);
    return await r.json();
  } catch(e){ /* lanjut ke proxy berikut */ }

  // 2) corsproxy.io
  try {
    const url = 'https://corsproxy.io/?' + encodeURIComponent(directUrl);
    const r = await fetchWithTimeout(url);
    return await r.json();
  } catch(e){}

  // 3) allorigins/raw
  try {
    const url = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(directUrl);
    const r = await fetchWithTimeout(url);
    return await r.json();
  } catch(e){}

  // 4) allorigins/get → balas { contents: "<...>" }
  const u = 'https://api.allorigins.win/get?url=' + encodeURIComponent(directUrl) + '&cache=' + Date.now();
  const rr = await fetchWithTimeout(u);
  const box = await rr.json(); // { contents, status }
  try { return JSON.parse(box.contents); }
  catch(e){ throw new Error('Proxy returned non-JSON'); }
}

function fetchWithTimeout(url){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), REQ_TIMEOUT);
  return fetch(url, { signal: controller.signal }).finally(()=>clearTimeout(t));
}

async function checkOne(domain){
  const url = buildDirectUrl(domain);
  const data = USE_PROXY ? await fetchJsonWithFallback(url)
                         : await (await fetchWithTimeout(url)).json();
  // Data: { "<domain>": { blocked: true/false } }
  const key = Object.keys(data)[0] || domain;
  const isBlocked = !!(data[key] && data[key].blocked === true);
  return { blocked: isBlocked, raw: data, source: 'skiddle' };
}

/** ============== LOOP CEK ============== **/
async function runCheckAll(){
  if (LIST.length === 0) return;
  if (elStatLast) elStatLast.textContent = nowStr();

  const jobs = LIST.map(d => async ()=>{
    try{
      const got = await checkOne(d);
      const ts = nowStr();
      MAP.set(d, { blocked: got.blocked, source: got.source, reason: '', lastCheck: ts, raw: got.raw });
      if (got.blocked){
        if (!BLOCKED_MAP.has(d)) BLOCKED_MAP.set(d, { since: ts, source: got.source, reason: '' });
      } else {
        if (BLOCKED_MAP.has(d)) BLOCKED_MAP.delete(d);
      }
    }catch(e){
      MAP.set(d, { blocked: null, source: 'error', reason: String(e?.message || e), lastCheck: nowStr() });
    }
  });

  await limitedParallel(jobs, MAX_CONCURRENT);
  renderAllTable(); renderBlockedTable(); renderStats();
}

/** ============== STATE HANDLERS ============== **/
function readListFromTextarea(){
  const lines = elUrls.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const set = new Set();
  for (const line of lines){ const d = normalizeDomain(line); if (d) set.add(d); }
  LIST = Array.from(set).slice(0,200);
}
function fillTextareaFromList(){ elUrls.value = LIST.join('\n'); }
function saveState(){ store.save({ list: LIST, interval: clampInt(+elInterval.value||30,5,600) }); }
function loadState(){
  const { list, interval } = store.load();
  LIST = Array.isArray(list)?list:[];
  elInterval.value = interval || 30;
  fillTextareaFromList();
  renderAllTable(); renderBlockedTable(); renderStats();
}
function startLoop(){
  if (LIST.length===0){ readListFromTextarea(); saveState(); }
  if (LIST.length===0){ alert('Daftar domain kosong. Isi textarea lalu Simpan.'); return; }
  const sec = clampInt(+elInterval.value||30,5,600);
  elInterval.value = sec; saveState();
  if (CHECK_TIMER) clearInterval(CHECK_TIMER);
  CHECK_TIMER = setInterval(runCheckAll, sec*1000);
  runCheckAll();
  elStatusRun.textContent = `Status: berjalan (setiap ${sec} dtk)`;
  elStatusRun.classList.remove('warn'); elStatusRun.classList.add('ok');
}
function stopLoop(){
  if (CHECK_TIMER) clearInterval(CHECK_TIMER);
  CHECK_TIMER = null;
  elStatusRun.textContent = 'Status: berhenti';
  elStatusRun.classList.remove('ok'); elStatusRun.classList.add('warn');
}
function resetAll(){
  stopLoop();
  LIST = []; MAP.clear(); BLOCKED_MAP.clear();
  try{ localStorage.removeItem('acb-data'); }catch{}
  elUrls.value = ''; elInterval.value = 30;
  if (elStatTotal) elStatTotal.textContent = 0;
  if (elStatOk) elStatOk.textContent = 0;
  if (elStatBad) elStatBad.textContent = 0;
  if (elStatLast) elStatLast.textContent = '-';
  tblAll.innerHTML = ''; tblBlocked.innerHTML = '';
  elStatusRun.textContent = 'Status: berhenti';
  elStatusRun.classList.remove('ok'); elStatusRun.classList.add('warn');
}

/** ============== EVENTS ============== **/
elSaveList.addEventListener('click', ()=>{ readListFromTextarea(); saveState(); renderAllTable(); renderBlockedTable(); renderStats(); });
elStart.addEventListener('click', startLoop);
elStop.addEventListener('click', stopLoop);
elReset.addEventListener('click', ()=>{ if (confirm('Hapus semua daftar & reset dari awal?')) resetAll(); });

// Init
loadState();
stopLoop();
</script>
</body>
</html>
